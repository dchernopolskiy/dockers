Icon="dockerMan.png"
Menu="ExtensionMenu"
Title="Docker"
---
<?php
function pgrep($process_name) {
	$pid = exec("pgrep $process_name", $output, $retval);
	if ($retval != 0)
		$pid = FALSE;
	return $pid;
}

// Docker configuration file
$cfgfile = "/boot/config/docker.cfg";

// Set defaults
$dockercfg = array(
	'DOCKER_HOME' => '/mnt/cache/docker',
	'DOCKER_OPTS' => '--storage-driver=btrfs',
	'DOCKER_CONTAINERS' => ''
);

if (file_exists($cfgfile)) {
	$dockercfg = array_merge($dockercfg, parse_ini_file($cfgfile));
}

$docker_image_exists = file_exists($dockercfg['DOCKER_HOME']);

# Update the start/stop configuration
if ($_POST){
	$container = trim($_POST['#container']);
	unset($_POST['#container']);

	$new_containers = "";
	if( strpos($dockercfg["DOCKER_CONTAINERS"], $container) !== FALSE){
		foreach( explode(',', $dockercfg["DOCKER_CONTAINERS"]) as $ct) {
			$ct = trim($ct);
			if (strlen($ct)){
				if(preg_match("/\b{$ct}\b/", $container) === 0){
					$new_containers = $new_containers.$ct.",";
				}
			}
		}
	} else {
		$new_containers = $dockercfg["DOCKER_CONTAINERS"].",$container,";
	}
	$new_containers = preg_replace("/,,|,$|^,/","", $new_containers);

	$_POST["DOCKER_CONTAINERS"] = $new_containers;
	include("/usr/local/emhttp/plugins/webGui/update_cfg.php");

} else {

//Calculate the date interval
function dateInterval($d){
	$date1 = new DateTime($d, new DateTimeZone('UTC'));
	$date2 = new DateTime();
	$interval = $date1->diff($date2);
	$d  = $interval->y ? $interval->y." year(s), " : "";
	$d .= $interval->d ? $interval->d." day(s), " : "";
	$d .= $interval->h ? $interval->h." hour(s), " : "";
	$d .= $interval->i ? $interval->i." minute(s), " : "";
	$d .= $interval->s ? $interval->s." second(s)" : "";
	return $d;
}

//Get container info from JSON output
function get_containers(){
	$containers = array();
	exec("docker ps -a -q", $containersID, $retr_val);

	foreach($containersID as $id){
		$c = array();
		$output = shell_exec("docker inspect {$id}");
		$obj = json_decode($output)[0];

		$c["Hostname"]  = $obj->Config->Hostname;
		$c["Image"]     = $obj->Config->Image;
		$c["Name"]      = substr($obj->Name, 1);
		$c["Running"]   = $obj->State->Running;
		$c["Cmd"]       = implode(" ",$obj->Config->Cmd);

		// Format uptime
		$StartedAt = substr($obj->State->StartedAt, 0, 19);
		$Created = substr($obj->Created, 0, 19);
		$c["Uptime"]  = dateInterval($StartedAt);
		$c["Created"] = dateInterval($Created);

		$ports = array();
		foreach($obj->HostConfig->PortBindings as $key => $value){
			$ports[] = $value[0]->HostIp.":".$value[0]->HostPort." -> ".$key;
		};
		$c["Ports"] = $ports;

		$containers[] = $c;
	}
	return $containers;
}

//Get params from CLI output
function get_params($cmd){
	$containers = array();
	$values = array();
	exec($cmd, $output, $retval);
	preg_match_all("/(\S+\s?\S+[\s]{0,100})/", $output[0], $matches);
	foreach($matches[1] as $v){
		$values[] = array( "name" => trim($v), "length" => strlen($v));
	}
	unset($output[0]);
	foreach( $output as $v){
		$stpos = 0;
		$content = array();
		for($i = 0; $i < count($values); ++$i){
			$str_length = $values[$i]['length'];
			$content[$values[$i]["name"]] = trim(substr($v, $stpos, $str_length));
			$stpos += $str_length;
		}
		end($content);
		$key = key($content);
		reset($content);
		$content[$key] .= substr($v, $stpos, strlen($v));
		$containers[] = $content;
	}
	return $containers;
}

function is_autostart($ct_name, $string){
	foreach( explode(',', $string) as $x) {
		if ( $x == $ct_name){
			return TRUE;
		}
	}
	return FALSE;
}

// array must be started since that's where we store domains
//
if ($var['fsState'] != "Started") {
?>
  <p class="notice">Array must be Started to view Docker plugins.</p>
  <?php
	return;
}

if (pgrep('docker') === FALSE) { ?>

<form markdown="1" method="POST" action="/plugins/webGui/exec.php" target="progressFrame">
<input type="hidden" name="command" value="/etc/rc.d/rc.docker start" />  

Service Status:

:   Shut down
    > Before you can start the Docker service for the first time, please specify a folder 
    > path for Docker to install to.  Once started, Docker will always automatically start 
    > after the array has been started.

:   <input type="submit" value="Start" />

</form>

<form markdown="1" method="POST" action="/plugins/webGui/update_cfg.php" target="progressFrame">
<input type="hidden" name="#file" value="<?=$cfgfile;?>" />

Docker Install Location:

:   <input type="text" name="DOCKER_HOME" value="<?=$dockercfg['DOCKER_HOME'];?>" placeholder="e.g. /mnt/cache/docker" />
    > You must specify a btrfs formatted path for Docker.  The system will automatically
    > create any subfolders under this path when the Docker service is started.

:   <input type="submit" value="Apply" />

</form>

<?PHP } else { ?>

<form markdown="1" method="POST" action="/plugins/webGui/exec.php" target="progressFrame">
<input type="hidden" name="command" value="/etc/rc.d/rc.docker stop" />

Service Status:

:   Started
    > Before you can start the Docker service for the first time, please specify a folder
    > path for Docker to install to.  Once started, Docker will always automatically start
    > after the array has been started.

:   <input type="submit" value="Stop" />

Docker Install Location:

:   <?=$dockercfg['DOCKER_HOME'];?>
    > You must specify a btrfs formatted path for Docker.  The system will automatically
    > create any subfolders under this path when the Docker service is started.

</form>

<?PHP } ?>

<? if (pgrep('docker')) { 


?>
<br>
<link type="text/css" rel="stylesheet" href="/plugins/webGui/style/default_tablesorter.css">
<script type="text/javascript" src="/plugins/vendor/tablesorter/jquery.tablesorter.min.js"></script>

<style>
  a.log{cursor:zoom-in;}
  a.exec{cursor:pointer;}
</style>

<script type="text/javascript" charset="utf-8">
$(document).ready(function() {
  $("#docker_containers").tablesorter( {sortList: [[1,0]]} );
  $('#docker_containers tr:even').addClass('odd');
  $("#docker_images").tablesorter( {sortList: [[0,0]]} );
  $('#docker_images tr:even').addClass('odd');
});
function autoStart(container){
  document.getElementsByName("#container")[0].value = container;
  document.forms["formAutostart"].submit();
};
function containerControl(container, action){
  document.getElementById("#cmdStartStop").value = "/usr/bin/docker " + action + " " + container;
  document.forms["formStartStop"].submit();
};
function execWithLog(cmd, desc, ask, reload) {
  if (ask){
    r = confirm(desc+"\n\nAre you sure?");
    if (r == false){return;}
  }
  Shadowbox.open({
    content: "/plugins/dockerMan/execWithLog.php?cmd=" + cmd,
    player:'iframe',
    title: desc,
    height:((screen.height*2)/3)||0,
    width:((screen.width*2)/3)||0,
    options:{
      onClose: function(){ if (reload){location.reload();}},
    }
  });
};
function addDocker() {
  reload=true;
  Shadowbox.open({
    content: "/plugins/dockerMan/CreateDocker.php",
    player:'iframe',
    title: 'Create Container:',
    height:((screen.height*2)/3)||0,
    width:'670px',
    options:{
      onClose: function(){ if (reload){location.reload();}},
    }
  });
};
</script>

<form markdown="1" id="formAutostart" method="POST" action="" target="progressFrame">
<input type="hidden" name="#container" value="none" />
<input type="hidden" name="#file" value="<?=$cfgfile;?>" />
</form>

<form method="POST" id="formStartStop" action="/plugins/webGui/exec.php" target="progressFrame">
<input type="hidden" id="#cmdStartStop" name="command" value="" />
</form>

<div id="title"><span class="left"><img src="/plugins/dockerMan/dockerMan.png" class="icon" width="16" height="16">Docker Containers</span><div style="text-align:right;"><a class="exec" onclick="addDocker();"><img src="/plugins/dockerMan/plus.png" alt="plus" width="30px" height=""></a> </div></div>
<table class="tablesorter" id="docker_containers">
  <thead>
    <tr><th>CONTROL</th><th>NAME</th><th>IMAGE</th><th>COMMAND</th><th>CREATED</th><th>STATUS</th><th>PORTS</th><th>CONTAINER ID</th><th>AUTOSTART</th><th>REMOVE</th></tr>
  </thead>
  <tbody>
    <? $all_containers = get_containers();
       foreach($all_containers as $ct){ ?>
    <tr>
      <td><?
      print $ct["Running"] ? 
      "<button style=\"color:#FF2400;font-weight:bold;width: 4em;\" onclick=\"containerControl('".$ct['Name']."','stop'); return true;\">Stop</button>":
      "<button style=\"color:#52D017;font-weight:bold;width: 4em;\" onclick=\"containerControl('".$ct['Name']."','start'); return true;\">Start</button>";
      ?></td>
      <td><?=$ct['Name'];?></td>
      <td><?=$ct['Image'];?></td>
      <td><?=$ct['Cmd'];?></td>
      <td><?=$ct['Created'];?></td>
      <td><a class="log" onclick="execWithLog('/usr/bin/docker logs <?=$ct['Name'];?>','Log for <?=$ct['Name'];?>', false, false)"><?=$ct['Uptime'];?></a></td>
      <td><?=implode("<br>", $ct['Ports']);?></td>
      <td><?=$ct['Hostname'];?></td>
      <? $checked = is_autostart($ct['Name'], $dockercfg['DOCKER_CONTAINERS']) ? "checked" : ""; ?>
      <td><input type="checkbox"  onclick="autoStart('<?=$ct['Name'];?>'); return true;" <?=$checked;?>></td>
      <td><a class="exec" onclick="execWithLog('/usr/bin/docker rm <?=$ct['Name'];?>','Removing container: <?=$ct['Name'];?>', true, true)">Remove</a></td>
    </tr>
    <?};?>
  </tbody>
</table>
<br>

<div id="title"><span class="left"><img src="/plugins/dockerMan/dockerMan.png" class="icon" width="16" height="16">Docker Images</span></div>
<table class="tablesorter" id="docker_images">
  <thead>
    <tr><th>REPOSITORY</th><th>TAG</th><th>IMAGE ID</th><th>CREATED</th><th>VIRTUAL SIZE</th><th>REMOVE</th></tr>
  </thead>
  <tbody>
    <? $all_images = get_params("docker images");
       foreach($all_images as $image){ 
       $rmi = (preg_match ("/<none>/", $image['REPOSITORY'])) ? $image['IMAGE ID']: $image['REPOSITORY']; ?>
    <tr>
      <td><?=htmlentities($image['REPOSITORY']);?></td>
      <td><?=htmlentities($image['TAG']);?></td>
      <td><?=htmlentities($image['IMAGE ID']);?></td>
      <td><?=htmlentities($image['CREATED']);?></td>
      <td><?=htmlentities($image['VIRTUAL SIZE']);?></td>
      <td><a class="exec" onclick="execWithLog('/usr/bin/docker rmi -f <?=htmlentities($rmi);?>','Removing image: <?=htmlentities($rmi);?>', true, true )">Remove</a></td>
    </tr>
    <?};?>
  </tbody>
</table>

<?};};?>
